Array.prototype.remove = function(from, to) {
    var rest = this.slice((to || from) + 1 || this.length);
    this.length = from < 0 ? this.length + from : from;
    return this.push.apply(this, rest);
};

function ProjCntr($scope) {
<<<<<<< HEAD
    var today = moment().add('days', -7),
        days = 14;
    $scope.tasks = [];
    $scope.tasksDone = {};
=======
    var today = moment(),
        days = 14,
        tasks = [],
        tasksDone = {};
>>>>>>> 48c5dcfe00d0d6b43d53cb159d4302b6c67977d2
    $scope.formHidden = true;
    $scope.points = 0;
    $scope.saveStr = '';
    $scope.loadStr = '';
    $scope.dates = [];
    // Initial Defaults - will be replaced with real tasks
    tasks.push({
        name: "Add a Task",
        start_date: today.unix(),
        end_date: null
    });
    tasks.push({
        name: "Another Task",
        start_date: today.unix(),
        end_date: null
    });
    
    var update = function() {
        this.dates = []; // Clear dates array
        for(var i = 0; i < days; i++) {
            var day = {};
            var thisDay = moment.unix(today.unix()).add('days', i);
            day.date = thisDay.format('MMMM Do');
            day.ddd = thisDay.format('ddd');
            day.timestamp = thisDay.unix();
            day.dailyTasks = [];
            for (var j=0; j < tasks.length; j++){
                var task = {};
                task.name = tasks[j].name;
                if(typeof tasksDone[j] != 'undefined' && tasksDone[j].indexOf(thisDay.unix()) ){
                    task.status = 1;
                } else {
                    task.status = 0;
                }
                day.dailyTasks.push(task);
            }
            // Push to dates array
            $scope.dates.push(day);
        }
    };
    var calcScore = function() {
        var day = 5; // 5 points per task
        var td = $scope.tasksDone;
        var points = 0;
        for(var i in td) {
            points += td[i].length * day;
        }
        $scope.points = points;
    };
    $scope.addTask = function(key) {
        if(typeof key != 'undefined' && key !== '') {
            $scope.tasks[key].name = $scope.newName;
            $scope.tasks[key].description = $scope.newDescription;
            $scope.tasks[key].start_date = $scope.newStartDate;
            $scope.tasks[key].end_date = $scope.newEndDate;
            $scope.formHidden = true;
            $scope.newName = "";
            $scope.newDescription = "";
            $scope.newStartDate = "";
            $scope.newEndDate = "";
            $scope.taskKey = "";
        } else {
            $scope.tasks.push({
                name: $scope.newName,
                start_date: today,
                end_date: null
            });
            $scope.newName = "";
        }
    };
    $scope.delete = function(key) {
        $scope.tasks.remove(key);
    };
    $scope.edit = function(key) {
        $scope.newName = $scope.tasks[key].name;
        $scope.newDescription = $scope.tasks[key].description;
        $scope.newStartDate = $scope.tasks[key].start_date;
        $scope.newEndDate = $scope.tasks[key].end_date;
        $scope.taskKey = key;
        $scope.formHidden = false;
    };
    $scope.taskIsHidden = function() {
        return $scope.formHidden;
    };
    $scope.done = function(key, ts, done) {
        if(done) {
            if(typeof $scope.tasksDone[key] == 'undefined') {
                $scope.tasksDone[key] = [];
                $scope.tasksDone[key].push(ts);
            } else {
                $scope.tasksDone[key].push(ts);
            }
            //             console.log($scope.tasksDone);
        } else {
            var i = $scope.tasksDone[key].indexOf(ts);
            $scope.tasksDone[key].splice(i, 1);
            //             console.log(i);
        }
        calcScore();
    };
    $scope.isDone = function(key, day) {
        if(typeof $scope.tasksDone[key] == 'undefined') {
            return false;
        } else if($scope.tasksDone[key].indexOf(day) >= 0) {
            return true;
        } else {
            return false;
        }
    };
    $scope.save = function() {
        console.log(this.tasksDone);
        saveObj = {
            tasks: $scope.tasks,
            tasksDone: $scope.tasksDone
        };
        saveJson = JSON.stringify(saveObj);
        $scope.saveStr = Base64.encode(saveJson);
    };
    $scope.load = function() {
        this.tasks = [];
        this.tasksDone = {};
        this.loadStr = Base64.decode(this.loadStr);
        this.loadStr = JSON.parse(this.loadStr);
        $scope.tasksDone = this.loadStr.tasksDone;
        $scope.tasks = this.loadStr.tasks;
        this.loadStr = '';
    };
    $scope.changeDate = function(direct) {
        if(direct == 'prev') {
            today.add('days', -1 * days);
        } else {
            today.add('days', days);
        }
        update();
    };
    update();
}